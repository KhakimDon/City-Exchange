name: Deploy to Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
    
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy Backend
      run: |
        echo "üöÄ Deploying Backend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          cd /opt/city-exchange || mkdir -p /opt/city-exchange
          cd /opt/city-exchange
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          if [ ! -d ".git" ]; then
            git clone ${{ secrets.REPO_URL }} .
          fi
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          
          # Backend deployment
          cd Backend
          
          # –°–æ–∑–¥–∞–µ–º venv –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ collectstatic
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
          sudo systemctl restart city-exchange-backend || echo "Service not found, will be created"
          sudo systemctl restart city-exchange-bot || echo "Service not found, will be created"
        EOF
    
    - name: Deploy Frontend
      run: |
        echo "üöÄ Deploying Frontend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          cd /opt/city-exchange/Frontend
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —Å–±–æ—Ä–∫–∞
          if command -v bun &> /dev/null; then
            bun install
            bun run build
          else
            npm install
            npm run build
          fi
          
          # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ nginx (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
          if [ -d "/var/www/city-exchange" ]; then
            sudo cp -r dist/* /var/www/city-exchange/
            sudo systemctl reload nginx || echo "Nginx not configured"
          fi
        EOF
    
    - name: Setup systemd services (first time)
      run: |
        echo "‚öôÔ∏è Setting up systemd services..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å –¥–ª—è Django backend
          sudo tee /etc/systemd/system/city-exchange-backend.service > /dev/null << 'SERVICE'
[Unit]
Description=City Exchange Django Backend
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/city-exchange/Backend
Environment="PATH=/opt/city-exchange/Backend/venv/bin"
ExecStart=/opt/city-exchange/Backend/venv/bin/gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
SERVICE

          # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å –¥–ª—è Telegram –±–æ—Ç–∞
          sudo tee /etc/systemd/system/city-exchange-bot.service > /dev/null << 'SERVICE'
[Unit]
Description=City Exchange Telegram Bot
After=network.target city-exchange-backend.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/city-exchange/Backend
Environment="PATH=/opt/city-exchange/Backend/venv/bin"
ExecStart=/opt/city-exchange/Backend/venv/bin/python manage.py run_bot
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
SERVICE

          # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º systemd –∏ –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
          sudo systemctl daemon-reload
          sudo systemctl enable city-exchange-backend
          sudo systemctl enable city-exchange-bot
          sudo systemctl start city-exchange-backend || true
          sudo systemctl start city-exchange-bot || true
        EOF
    
    - name: Check services status
      run: |
        echo "üìä Checking services status..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "=== Backend Status ==="
          sudo systemctl status city-exchange-backend --no-pager -l || true
          echo ""
          echo "=== Bot Status ==="
          sudo systemctl status city-exchange-bot --no-pager -l || true
        EOF
    
    - name: Notify deployment success
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "Backend should be running on http://${{ secrets.SERVER_HOST }}:8000"
